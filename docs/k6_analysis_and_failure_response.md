# k6 부하 테스트 결과 분석 및 장애 대응 문서

## 테스트 개요

- **대상 API**: `POST /api/v1/coupons/issue`
- **테스트 목적**: 선착순 쿠폰 발급 API의 대량 요청 처리 능력, 병목 발생 구간 확인, 장애 대응 준비
- **테스트 도구**: k6

---

## 부하 조건 비교

| 항목 | 1차 테스트 | 2차 테스트 (강화) |
|------|------------|-------------------|
| 가상 사용자 수 | 최대 1000명 | 최대 8000명 |
| stages | 총 30초 (5 + 5 + 5 + 10 + 5) | 총 60초 (10 + 10 + 10 + 20 + 10) |
| 요청 수 | 약 18,933 | 약 155,360 |
| 평균 응답 시간 | 3.19ms | **869.33ms** |
| 실패율 | 0% | **1.05% (1,632건)** |
| 최대 응답 시간 | 약 424ms | **8.73s** |
| p95 응답 시간 | 5.58ms | **2.79s** |

---

## 성능 분석

### 1. 응답 속도
- 1차: 대부분의 요청이 5ms 이내 응답 → 매우 안정적
- 2차: 평균 응답이 869ms, p95는 2.79s → **지연 현상 확인**

### 2. 실패율 증가
- 1차: 0% (완전 성공)
- 2차: 1.05% 실패 → Kafka, Redis, DB 등의 병목 가능성

### 3. 시스템 부하 지점
- Redis 재고 감소 병렬 처리 지연 가능
- Kafka 메시지 발행 지연 또는 큐 적체 발생 가능성
- DB Lock / 중복 검사로 인한 응답 지연

---

## 개선 제안

| 구간 | 문제 | 개선안 |
|------|------|--------|
| Redis | 재고 감소 Lua 처리로 동시 처리 한계 | `SADD + LPOP` 사용으로 atomic 처리 |
| Kafka | `send().get()` 방식 동기 처리 병목 | `send()` + `Callback` + DLQ 활용 |
| DB | 중복 삽입 검사 시 Lock 발생 | Redis Cache로 사전 중복 필터링 |
| Thread | 톰캣 maxThreads 한계 도달 | 비동기 풀, 큐 처리 확장 고려 |

---

## 장애 대응 시나리오

### S-001: Redis 병목
- **증상**: timeout 또는 blocking
- **대응**:
    1. `MONITOR`, `INFO`로 blocked_clients 확인
    2. 서버 장애 시 fallback 메시지로 전환
    3. 장애 시간 동안 발급 중단 및 메시지 노출

### S-002: Kafka 발행 실패
- **증상**: 메시지 누락, DLQ로 전송됨
- **대응**:
    1. DLQ로 전송되면 관리자 알림
    2. 운영자 수동 재처리 or Batch 처리 Job 실행

### S-003: DB Lock 과다
- **증상**: insert 대기 / Lock Timeout
- **대응**:
    1. 인입 큐를 Redis로 분산 처리
    2. Retry 정책 3회까지만 허용
    3. Lock 쿼리 로그 추적 후 튜닝

---

## 결론 및 다음 단계

- 시스템은 1000명 수준의 동시성은 안정적으로 처리 가능
- 8000명 수준에서는 응답 지연 및 실패가 발생함
- Redis, Kafka, DB의 **비동기 처리 및 캐싱 최적화**가 필요
- 실 서비스 런칭 전 `부하 상한선 설정` 및 `Graceful Degradation 정책` 마련 필요

---

## 첨부

- `script.js` - 테스트 스크립트
- `result_8000vus.json` - 테스트 결과 raw 데이터
- `grafana-dashboard-snapshot.png` - 메트릭 시각화 (선택)

