# MSA 전환 시 도메인별 서비스 설계 및 트랜잭션 처리 전략

## 1. 설계 목적

현재 단일 서비스로 구현된 주문, 결제, 포인트, 쿠폰 등의 기능을 서비스의 확장성과 유지보수성을 위해 **도메인 중심의 MSA(Microservice Architecture)**로 분리하고자 한다. 이를 통해 각 도메인이 독립적으로 배포되고 운영될 수 있도록 하며, 서비스 간 결합도를 낮춘다.

---

## 2. 도메인 분리 및 책임

| 도메인        | 배포 단위 서비스         | 주요 책임                                |
|---------------|-------------------|--------------------------------------|
| 주문 (Order)   | `orderSservice`   | 주문 생성, 상태 관리, 주문 내역 조회 등             |
| 포인트 (Point) | `pointSservice`   | 포인트 충전/결제, 요청/응답, 상태 관리, PG 연동 이력 관리 |
| 쿠폰 (Coupon)  | `couponSservice`  | 쿠폰 발급, 사용, 만료 처리                     |
| 상품 (Product) | `productSservice` | 상품 재고 및 인기 상품 점수 관리                  |

---

## 3. 서비스 간 연동 흐름

### 3.1 결제 처리 플로우

1. `pointService`로 결제 및 포인트 사용 이력 저장 요청
2. 결제 성공 시 `orderService`로 응답
3. 주문 상태를 `PAID`로 변경

---

## 4. 트랜잭션 처리의 한계

### 문제점: **분산 트랜잭션 미지원**

- 서비스 간 트랜잭션 경계가 분리되어 있음
- 한 서비스의 실패가 전체 일관성을 깨뜨릴 수 있음
- DB 간 글로벌 트랜잭션(JTA, XA)은 복잡하고 비효율적

---

## 5. 해결 전략

### 5.1 [추천] SAGA 패턴

#### 개념
- 각 서비스가 로컬 트랜잭션을 수행한 후 다음 서비스로 전달
- 실패 시 보상 트랜잭션 수행

#### 예시 플로우

| 단계 | 서비스                         | 설명                                |
|------|-----------------------------|-------------------------------------|
| 1    | `pointService`              | `pointService`로 결제 및 포인트 사용 이력 저장 요청                          |
| 2    | `orderService`              |  결제 성공 시 `orderService`로 응답                    |
| 3    | `orderService`              | 주문 상태를 `PAID`로 변경                    |
| ❌ 실패 시 | `pointService`,`orderService` | 보상 트랜잭션 수행 (주문 취소, 포인트/쿠폰 복원 등) |

---

## 6. SAGA 처리 방식

| 방식            | 설명                                | 특징                      |
|-----------------|-------------------------------------|---------------------------|
| Choreography    | 이벤트 기반 서비스 간 연동           | 느슨한 결합, 복잡한 흐름  |
| Orchestration   | 중앙 서비스가 흐름 제어               | 흐름 명확, 테스트 쉬움    |

---

## 7. 데이터 정합성 보장 전략

| 항목                | 방안                                        |
|---------------------|-------------------------------------------|
| 로컬 트랜잭션       | 각 서비스 내 `@Transactional` 처리               |
| 전역 정합성         | SAGA 패턴 적용                                |
| 중복 처리 방지      | 비관적락, 낙관적락 , Distributed Lock, Redis 등 활용 |
| 실패 복구           | DLQ, 재시도 큐, Dead Letter Queue 설정          |

---

## 8. 테스트 전략

| 테스트 유형       | 목적                                               |
|------------------|----------------------------------------------------|
| 단위 테스트       | 도메인 로직 검증                                   |
| 통합 테스트       | 서비스 간 요청-응답 및 보상 처리 흐름 검증         |
| 장애 복구 테스트  | 부분 실패 시 일관성 유지 여부 검증                 |

---

## 9. 결론

MSA 환경에서는 도메인 중심의 서비스 분리를 통해 확장성과 유지보수성을 향상시킬 수 있으며, 
데이터 정합성을 위해 SAGA 패턴 기반의 보상 트랜잭션 처리 전략을 적용하는 것이 현실적이고 안정적이다. 
각 도메인은 자신의 책임 내에서만 동작하며, 외부 시스템 간 협력은 명확한 경계와 이벤트 흐름을 통해 처리해야 한다.
