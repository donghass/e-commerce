# λ™μ‹μ„± μ΄μ μ‹λ³„ λ° ν•΄κ²° λ³΄κ³ μ„

## 1. λ‚™κ΄€μ  λ½ μ μ© μ‚¬λ΅€ - ν¬μΈνΈ μ¶©μ „ μ‹μ¤ν…
π›  λ¬Έμ  μΈμ‹
μ‚¬μ©μλ” ν¬μΈνΈλ¥Ό μ¶©μ „ν•  μ μμΌλ©°, μΌλ°μ μΌλ΅ ν• μ‹μ μ— ν• μ μ €κ°€ μ—¬λ¬ λ² ν¬μΈνΈ μ¶©μ „μ„ μ‹λ„ν•λ” κ²½μ°λ” λ“λ­„

ν•μ§€λ§ κ°„ν—μ μΌλ΅ λ™μ‹μ— μ¶©μ „ μ”μ²­μ΄ λ“¤μ–΄μ¬ κ²½μ°, λ°μ΄ν„° λ¶μΌμΉ μ„ν— λ°μƒ

### μ›μΈ λ¶„μ„
κΈ°λ³Έμ μΌλ΅ μ¶©μ „ μ”μ²­ μ‹ ν¬μΈνΈ μ”μ•΅μ„ μ΅°νν• λ’¤ κ³„μ‚° ν›„ μ—…λ°μ΄νΈ

λ™μ‹μ— μ”μ²­μ΄ λ“¤μ–΄μ¤λ©΄, μ΅°ν-κ³„μ‚°-μ—…λ°μ΄νΈ μ‚¬μ΄μ— λ°μ΄ν„°κ°€ λ‹¬λΌμ§ μ μμ β†’ Lost Update λ°μƒ κ°€λ¥

ν¬μΈνΈκ°€ 100 μ΄μκ³  100 μ¶©μ „ν•  κ²½μ°
1. 100 Tx select point = 100
3. 100 Tx update point = 200

2. 101 Tx select point = 100
4. 101 Tx update point = 200
   result point = 200
   μ΄λ ‡κ² ν¬μΈνΈ μ¶©μ „ λ™μ‹μ„± μ΄μ λ°μƒ

λ‹¤λ§ ν¬μΈνΈ μ¶©μ „μ€ μ—¬λ¬ μ‚¬μ©μκ°€ λ™μ‹ μ ‘κ·Όμ΄ μ•„λ‹ μ‚¬μ©μ 1λ…μ—κ²λ§ ν•΄λ‹Ήλμ–΄ κ²½ν•©μ΄ λ‚®λ‹¤κ³  μƒκ°ν•μ—¬ λ‚™κ΄€μ  λ½(@Version) μ‚¬μ© κ²°μ •

### ν•΄κ²° λ°©λ²•
JPA μ—”ν‹°ν‹°μ— @Version ν•„λ“ μ¶”κ°€ν•μ—¬ λ‚™κ΄€μ  λ½ μ μ©

μ¶©μ „ λ΅μ§ μ‹¤ν–‰ μ‹ OptimisticLockException λ°μƒν•  κ²½μ°, 1ν μ¬μ‹λ„ λ΅μ§ μ¶”κ°€


@Version
private Long version;
``` java
public PointResult chargePointWithRetry(ChargePointCommand command) {
        int retry = 1;

        while (retry-- > 0) {
            try {
                return chargePoint(command); // μ¶©μ „ λ΅μ§ νΈμ¶
            } catch (ObjectOptimisticLockingFailureException | OptimisticLockException e) {
                if (retry == 0) {
                    throw new BusinessException(PointErrorCode.CONFLICT);
                }
                try {
                    Thread.sleep(100); // μ κΉ λ€κΈ° ν›„ μ¬μ‹λ„
                } catch (InterruptedException ignored) {}
            }
        }

        throw new BusinessException(PointErrorCode.CONFLICT); // μ΄κ±΄ κ±°μ μ• ν„°μ§
    }
```
### λ€μ• μ μ‹
μ¶©μ „ μ”μ²­μ΄ λ”μ± λΉλ²ν•΄μ§ κ²½μ°μ—λ” Redis κΈ°λ° λ¶„μ‚° λ½μ„ μ‚¬μ©ν•κ±°λ‚

Kafka λ“±μΌλ΅ μ¶©μ „ μ”μ²­μ„ νμ‰ν•μ—¬ μ§λ ¬ μ²λ¦¬ν•λ” κµ¬μ΅°λ„ κ³ λ ¤ κ°€λ¥

## 2. λΉ„κ΄€μ  λ½ μ μ© μ‚¬λ΅€ - μΏ ν° λ°κΈ‰ / μ£Όλ¬Έ / μ£Όλ¬Έ μ·¨μ† μ‹μ¤ν…
π›  λ¬Έμ  μΈμ‹
μΏ ν° λ°κΈ‰, μ£Όλ¬Έ μ²λ¦¬, μ£Όλ¬Έ μ·¨μ†μ κ²½μ° μ§§μ€ μ‹κ°„μ— λ‹¤μμ μ‚¬μ©μκ°€ λ™μ‹μ— μ ‘κ·Όν•  μ μμ

μ •ν™•ν• μλ‰ μ μ–΄ λ° μ¤‘λ³µ λ°©μ§€κ°€ λ°λ“μ‹ ν•„μ”ν•¨

### μ›μΈ λ¶„μ„
λ™μ‹μ— μ—¬λ¬ μ μ €κ°€ λ™μΌ μΏ ν°μ„ λ°κΈ‰λ°›κ±°λ‚, λ™μΌ μƒν’μ„ μ£Όλ¬Έν•κ±°λ‚, μ£Όλ¬Έμ„ μ·¨μ†ν•  κ²½μ°

μ¬κ³ , μΏ ν° μλ‰, μ£Όλ¬Έ μƒνƒ λ“±μ λ°μ΄ν„° μ •ν•©μ„±μ΄ κΉ¨μ§ μ„ν— μ΅΄μ¬

ν•΄λ‹Ή μƒν™©μ€ κ°•ν• μ •ν•©μ„± λ³΄μ¥ ν•„μ”

### ν•΄κ²° λ°©λ²•
ν•΄λ‹Ή λ°μ΄ν„° μ΅°ν μ‹ .setLockMode(LockModeType.PESSIMISTIC_WRITE)   μ‚¬μ©ν•μ—¬ λΉ„κ΄€μ  λ½ μ μ©

DB μ°¨μ›μ—μ„ νΈλμ­μ… λ™μ• λ‹¤λ¥Έ μ“°κΈ°/μ½κΈ° μ ‘κ·Ό μ°¨λ‹¨

ν™•μ‹¤ν• λ™μ‹μ„± μ μ–΄ λ³΄μ¥

```java
@Override
    public Optional<CouponEntity> findByIdLock(Long couponId) {
        CouponEntity result = queryFactory
            .selectFrom(coupon)
            .where(coupon.id.eq(couponId))
            .setLockMode(LockModeType.PESSIMISTIC_WRITE)  // λ½ μ„¤μ •
            .fetchOne();

        return Optional.ofNullable(result);
    }
```
### λ€μ• μ μ‹
μ„±λ¥ λ³‘λ©μ΄ μ°λ ¤λλ‹¤λ©΄, Redis κΈ°λ° λ¶„μ‚°λ½(Redisson) λλ” Kafka Consumer λ‹¨μΌ μ²λ¦¬ λ°©μ‹ κ³ λ ¤

μΏ ν° λ°κΈ‰μ κ²½μ°, μΏ ν° μμ²΄λ¥Ό μ‚¬μ „μ— λ¶„μ‚°ν•μ—¬ μΊμ‹ μ²λ¦¬ν•λ” κµ¬μ΅°λ„ κ°€λ¥ (μ: μΉ΄μΉ΄μ¤ μΏ ν° λ°©μ‹)

### κ²°λ΅ 

| κµ¬λ¶„         | λ‚™κ΄€μ  λ½           | λΉ„κ΄€μ  λ½                     |
|--------------|---------------------|-------------------------------|
| μ μ© λ€μƒ    | ν¬μΈνΈ μ¶©μ „         | μΏ ν° λ°κΈ‰, μ£Όλ¬Έ, μ£Όλ¬Έ μ·¨μ†   |
| κ²½ν•© κ°€λ¥μ„±  | λ‚®μ                | λ†’μ                          |
| μ„±λ¥ μν–¥    | μ μ                | μμ                          |
| μ²λ¦¬ λ°©μ‹    | μ¶©λ μ‹ μ¬μ‹λ„      | μ¶©λ μμ²΄ λ°©μ§€               |
| μ ν•© μƒν™©    | μ¶©λμ΄ λ“λ¬Έ μ‹λ‚λ¦¬μ¤ | μ¶©λμ΄ μμ£Ό λ°μƒν•λ” ν•µμ‹¬ λ΅μ§ |
